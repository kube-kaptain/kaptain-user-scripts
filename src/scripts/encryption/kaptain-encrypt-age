#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# Encrypt all .raw files in src/secrets/ to .age files.
# Run from repo root. Symmetric with decrypt-secrets.
#
# Usage: encrypt-secrets
set -euo pipefail

# Handle --dir argument
if [[ $# -eq 0 ]]; then
  # No args - use env var or default
  SECRETS_DIR="${SECRETS_DIR:-src/secrets}"
elif [[ $# -eq 2 ]]; then
  if [[ "$1" != "--dir" ]]; then
    echo "ERROR: Unknown option: $1" >&2
    echo "Usage: $(basename "$0") [--dir DIR]" >&2
    exit 1
  fi
  if [[ "$2" == /* ]]; then
    echo "ERROR: --dir must be a relative path, i.e. a sub path of this repo" >&2
    exit 1
  fi
  if [[ ! -d "$2" ]]; then
    echo "ERROR: Directory not found: $2" >&2
    exit 1
  fi
  SECRETS_DIR="$2"
else
  echo "ERROR: Wrong argument count, must be 0 or 2." >&2
  echo "Usage: $(basename "$0") [--dir DIR]" >&2
  exit 1
fi

if [[ ! -d "${SECRETS_DIR}" ]]; then
  echo "ERROR: ${SECRETS_DIR} directory not found - run from repo root" >&2
  exit 1
fi

if ! command -v age &> /dev/null; then
  echo "ERROR: age is required but not installed" >&2
  exit 1
fi

if ! command -v age-keygen &> /dev/null; then
  echo "ERROR: age-keygen is required but not installed" >&2
  exit 1
fi

# Find .raw files
raw_files=()
while IFS= read -r -d '' file; do
  raw_files+=("$file")
done < <(find "${SECRETS_DIR}" -name "*.raw" -type f -print0)

if [[ ${#raw_files[@]} -eq 0 ]]; then
  echo "No .raw files found in ${SECRETS_DIR}"
  exit 0
fi

echo "Found ${#raw_files[@]} .raw file(s) to encrypt"

# Prompt for identity (secret key)
read -r -s -p "Enter passphrase: " identity
echo

# Validate identity is a valid age secret key
if [[ "${identity}" != AGE-SECRET-KEY-* ]]; then
  echo "ERROR: Not a valid age secret key" >&2
  exit 1
fi

# Derive public key (recipient) from identity
recipient=$(echo "${identity}" | age-keygen -y)

# Set up secure temp directory
KAPTAIN_TMP="${HOME}/.kaptain-tmp"
mkdir -p "${KAPTAIN_TMP}"
chmod 700 "${KAPTAIN_TMP}"
identity_file="${KAPTAIN_TMP}/age-identity.$$"
trap 'rm -f "${identity_file}"; rmdir "${KAPTAIN_TMP}" 2>/dev/null || true' EXIT

# Validate key against existing encrypted files
existing_file=$(find "${SECRETS_DIR}" -name "*.age" -type f | head -1)
if [[ -n "${existing_file}" ]]; then
  echo "Validating key against existing encrypted file..."
  echo "${identity}" > "${identity_file}"
  chmod 600 "${identity_file}"
  if ! age -d -i "${identity_file}" < "${existing_file}" > /dev/null 2>&1; then
    echo "ERROR: Key does not match existing encrypted files" >&2
    exit 1
  fi
  echo "Key validated."
fi

# Encrypt each file
echo ""
for raw_file in "${raw_files[@]}"; do
  age_file="${raw_file%.raw}.age"
  dir=$(dirname "${raw_file}")
  echo "Encrypting ${dir}/{$(basename "${raw_file}") => $(basename "${age_file}")}"
  age -e -r "${recipient}" -o "${age_file}" "${raw_file}"
done
echo ""

echo "Done. Encrypted ${#raw_files[@]} file(s)"
