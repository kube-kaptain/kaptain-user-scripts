#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# Kaptain decrypt router - auto-detects encryption type and delegates
#
# Usage: kaptain-decrypt [--type TYPE] [--dir DIR]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEFAULT_SECRETS_DIR="src/secrets"

# Parse arguments
TYPE=""
DIR="${DEFAULT_SECRETS_DIR}"

usage() {
  echo "Usage: kaptain decrypt [--type TYPE] [--dir DIR]"
  echo ""
  echo "Options:"
  echo "  --type TYPE   Encryption type (auto-detected if omitted)"
  echo "  --dir DIR     Target directory (default: src/secrets)"
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --type)
      if [[ $# -lt 2 ]]; then
        echo "ERROR: --type requires a value" >&2
        usage >&2
        exit 1
      fi
      TYPE="$2"
      shift 2
      ;;
    --dir)
      if [[ $# -lt 2 ]]; then
        echo "ERROR: --dir requires a value" >&2
        usage >&2
        exit 1
      fi
      DIR="$2"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "ERROR: Unknown option: $1" >&2
      usage >&2
      exit 1
      ;;
  esac
done

if [[ ! -d "${DIR}" ]]; then
  echo "ERROR: Directory not found: ${DIR}" >&2
  exit 1
fi

# Check gitignore configuration before proceeding
"${SCRIPT_DIR}/kaptain-encryption-check-ignores" --dir "${DIR}"

# Discover supported types from available scripts
SUPPORTED_TYPES=()
for script in "${SCRIPT_DIR}"/kaptain-decrypt-*; do
  if [[ -x "${script}" ]]; then
    suffix="${script##*kaptain-decrypt-}"
    SUPPORTED_TYPES+=("${suffix}")
  fi
done

# Check if type is supported
is_supported_type() {
  local check_type="$1"
  local t
  for t in "${SUPPORTED_TYPES[@]}"; do
    if [[ "${t}" == "${check_type}" ]]; then
      return 0
    fi
  done
  return 1
}

# Build extension list for detection
detect_type() {
  local found_type=""
  local found_count=0

  for suffix in "${SUPPORTED_TYPES[@]}"; do
    # Check for files with this extension
    local ext=".${suffix}"
    local count
    count=$(find "${DIR}" -name "*${ext}" -type f 2>/dev/null | wc -l | tr -d ' ')

    if [[ ${count} -gt 0 ]]; then
      if [[ -n "${found_type}" && "${found_type}" != "${suffix}" ]]; then
        echo "ERROR: Mixed encryption types detected in ${DIR}" >&2
        echo "  Found: .${found_type} and .${suffix}" >&2
        echo "  Use --type to specify which to decrypt" >&2
        exit 1
      fi
      found_type="${suffix}"
      found_count=${count}
    fi
  done

  if [[ -z "${found_type}" ]]; then
    echo "ERROR: No encrypted files found in ${DIR}" >&2
    echo "Supported extensions: ${SUPPORTED_TYPES[*]}" >&2
    exit 1
  fi

  echo "${found_type}"
}

# Determine type
if [[ -z "${TYPE}" ]]; then
  TYPE=$(detect_type)
  echo "Auto-detected type: ${TYPE}"
fi

# Validate type
if ! is_supported_type "${TYPE}"; then
  echo "ERROR: Unsupported encryption type: ${TYPE}" >&2
  echo "Supported types: ${SUPPORTED_TYPES[*]}" >&2
  exit 1
fi

# Delegate to specific script
DECRYPT_SCRIPT="${SCRIPT_DIR}/kaptain-decrypt-${TYPE}"

if [[ ! -x "${DECRYPT_SCRIPT}" ]]; then
  echo "ERROR: Decrypt script not found: ${DECRYPT_SCRIPT}" >&2
  exit 1
fi

# Export DIR for the script (they currently use hardcoded path, but future-proofing)
export SECRETS_DIR="${DIR}"
exec "${DECRYPT_SCRIPT}"
