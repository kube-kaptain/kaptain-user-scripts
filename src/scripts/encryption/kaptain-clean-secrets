#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# Clean decrypted secrets (.raw and .txt files) from secrets directories.
# Run from repo root.
#
# Usage: kaptain-clean-secrets [--dir DIR] [--dry-run]
set -euo pipefail

SECRETS_DIR="${SECRETS_DIR:-src/secrets}"
DRY_RUN=false

usage() {
  echo "Usage: kaptain clean secrets [--dir DIR] [--dry-run]"
  echo ""
  echo "Remove decrypted secret files (.raw, .txt) from secrets directory."
  echo ""
  echo "Options:"
  echo "  --dir DIR     Secrets directory (default: src/secrets)"
  echo "  --dry-run     Show what would be deleted without deleting"
  echo "  -h, --help    Show this help"
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      usage
      exit 0
      ;;
    --dir)
      if [[ $# -lt 2 ]]; then
        echo "ERROR: --dir requires a value" >&2
        usage
        exit 1
      fi
      SECRETS_DIR="$2"
      shift 2
      ;;
    --dry-run)
      DRY_RUN=true
      shift
      ;;
    *)
      echo "ERROR: Unknown option: $1" >&2
      usage
      exit 1
      ;;
  esac
done

# Reject absolute paths
if [[ "${SECRETS_DIR}" == /* ]]; then
  echo "ERROR: --dir must be a relative path, i.e. a sub path of this repo" >&2
  exit 1
fi

if [[ ! -d "${SECRETS_DIR}" ]]; then
  echo "ERROR: Secrets directory not found: ${SECRETS_DIR}" >&2
  exit 1
fi

# Find files to clean
raw_files=()
txt_files=()

while IFS= read -r -d '' file; do
  raw_files+=("$file")
done < <(find "${SECRETS_DIR}" -name "*.raw" -type f -print0 2>/dev/null)

while IFS= read -r -d '' file; do
  txt_files+=("$file")
done < <(find "${SECRETS_DIR}" -name "*.txt" -type f -print0 2>/dev/null)

total_count=$((${#raw_files[@]} + ${#txt_files[@]}))

if [[ ${total_count} -eq 0 ]]; then
  echo "No .raw or .txt files found in ${SECRETS_DIR}"
  exit 0
fi

echo "Found ${#raw_files[@]} .raw file(s) and ${#txt_files[@]} .txt file(s) in ${SECRETS_DIR}"

if [[ "${DRY_RUN}" == "true" ]]; then
  echo ""
  echo "Dry run - would delete:"
  if [[ ${#raw_files[@]} -gt 0 ]]; then
    for f in "${raw_files[@]}"; do
      echo "  ${f}"
    done
  fi
  if [[ ${#txt_files[@]} -gt 0 ]]; then
    for f in "${txt_files[@]}"; do
      echo "  ${f}"
    done
  fi
  exit 0
fi

# Delete files
deleted=0
echo ""
if [[ ${#raw_files[@]} -gt 0 ]]; then
  for f in "${raw_files[@]}"; do
    echo "Deleting ${f}"
    rm -f "${f}"
    deleted=$((deleted + 1))
  done
fi
if [[ ${#txt_files[@]} -gt 0 ]]; then
  for f in "${txt_files[@]}"; do
    echo "Deleting ${f}"
    rm -f "${f}"
    deleted=$((deleted + 1))
  done
fi
echo ""

echo "Deleted ${deleted} file(s)"
