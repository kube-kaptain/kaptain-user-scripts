#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# Decrypt all .age files in src/secrets/ to .txt files.
# Run from repo root. Symmetric with encrypt-secrets.
#
# Usage: decrypt-secrets
set -euo pipefail

SECRETS_DIR="src/secrets"

if [[ ! -d "${SECRETS_DIR}" ]]; then
  echo "ERROR: ${SECRETS_DIR} directory not found - run from repo root" >&2
  exit 1
fi

if ! command -v age &> /dev/null; then
  echo "ERROR: age is required but not installed" >&2
  exit 1
fi

# Find .age files
age_files=()
while IFS= read -r -d '' file; do
  age_files+=("$file")
done < <(find "${SECRETS_DIR}" -name "*.age" -type f -print0)

if [[ ${#age_files[@]} -eq 0 ]]; then
  echo "No .age files found in ${SECRETS_DIR}"
  exit 0
fi

echo "Found ${#age_files[@]} .age file(s) to decrypt"

# Prompt for identity (secret key)
read -r -p "Enter passphrase: " identity

# Validate identity is a valid age secret key
if [[ "${identity}" != AGE-SECRET-KEY-* ]]; then
  echo "ERROR: Not a valid age secret key" >&2
  exit 1
fi

# Write identity to temp file for age -i
identity_file=$(mktemp)
trap 'rm -f "${identity_file}"' EXIT
echo "${identity}" > "${identity_file}"

# Decrypt each file
for age_file in "${age_files[@]}"; do
  txt_file="${age_file%.age}.txt"
  echo "Decrypting ${age_file} -> ${txt_file}"
  age -d -i "${identity_file}" -o "${txt_file}" "${age_file}"
done

echo "Done. Decrypted ${#age_files[@]} file(s)"
